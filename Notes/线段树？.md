## 李超线段树

先来看一道例题。

### P4097

> 写一个数据结构维护以下两种操作：
>
> 1. 加入一条线段；
> 2. 查询所有线段再某一点处的最值。
>
> 强制在线。

李超线段树这个东西是用来维护线段（也即一次函数）极值的，现在我们考虑如何用线段树来维护这个东西。

加入一条线段本质上就是在做区间修改，那么我们考虑如何给当前区间打上标记以方便修改。首先我们定义标记为一条线段，它是当前区间的最大值。然后我们发现修改是很容易做的，问题出在如何更新这个标记上（怎么有种楼房重建的感觉）。

如果当前的区间内是没有标记的，那么我们直接打上标记即可。如果存在标记的话，我们考虑将当前加入的线段与原来这个区间内的标记作比较。通过画图我们可以得出，当前的区间会被加入的线段与之前的标记的极值分割点分为至多两段，且左右子区间内一定至少有一个是被其中的某一段完全包含了。对于这个被完全包含的部分，我们不需要做改动，使用较大的线段（不一定是当前加入的这一条）作为新的标记即可，对于另外一半，也就是极值分割点所在的那一段，我们需要递归的下传标记，直到叶子节点。不难发现，这本质上是一个线段树上二分的过程，二分的东西就是这个极值的分割点。

那么现在修改就比较好做了。先通过一般的修改操作，将带修改的区间分为线段树上的几个区间，再通过上边的过程给区间打上标记。复杂度很容易分析，对于第一个部分，我们都知道这样会把待修改的区间拆成线段树上的 $\log$ 个区间，对于第二部分，由于我们需要递归的下传标记，因此时间复杂度是 $\mathcal{O}(\log n)$ 级别的，因此加入一条线段的总时间复杂度是 $\mathcal{O}(\log^2 n)$ 的。

再考虑查询。查询的时候可以利用标记永久化的思想，将整棵树拆成 $\log$ 个包含查询点的区间，那么容易得到查询的时间复杂度是 $\mathcal{O}(\log n)$ 的。

李超线段树的一个很重要的应用是用来优化 DP 的转移。当我们发现 DP 的转移方程可以写成类似一次函数的形式时，李超树就能方便的用于其的转移。

## 线段树分治

这个东西主要是利用任意一个区间在线段树上都会被拆成 $\mathcal{O}(\log n)$ 个区间的特性，在时间轴上离线建线段树以减少有效时间点的个数，从而降低时间复杂度。

还是先来看一道题。

### P5787

> 给定一张图，其中每一条边都有其存在的时间范围，对每一个时刻询问当前图是否为一张二分图。

我们记操作次数与时间轴大小同级。

乍一看很没思路啊，一般我们判断一张图是否为二分图都是直接 DFS 染色一遍，但这个东西貌似很难找到好的方法优化。

另一种做法是扩域并查集，这个当然也是非常熟知的。类似 2-SAT，我们把每个点拆成两个点分别代表将当前这个点染成两种颜色，然后对于每条边将其两端的点的不同决策合并到一块，那么原图是二分图当且仅当不存在任意一个节点使得它对应的两种决策位于同一个连通块内。

这个东西貌似也不咋地，因为如果每次都重新建图那总的复杂度甚至比直接染色还多一个并查集的 $\log$。不过，我们知道有个东西叫做**可撤销并查集**，能够倒序回滚并查集的合并操作。有了这玩意之后我们就可以整点大的了。

我们发现，如果按照时间轴顺序枚举的话，即使有可撤销并查集也没啥大用处，因为这个东西并不支持**任意时刻**的删除，它只能倒着往回滚，因此并不是很符合顺序枚举的任意删边的要求，不过这样也确实引出了本题的另一种做法，那就是 LCT，但是我不会，因此我们还是考虑用并查集怎么做。

考虑把所有操作离线下来后在**时间轴上**分治，每次访问到某一个时间的区间，就将包含该区间的所有边插入并查集中，如果存在冲突就直接报告当前区间都不是二分图，否则将当前区间按中点划分为两个子区间，最后如果能递归到叶子，就说明在这个时间点上这张图是二分图。在结束当前区域内的递归后，我们会发现子区间中的所有合并操作都位于可撤销并查集操作栈的**栈顶**，满足了我们对可撤销并查集回滚操作的要求。

不过这样还是有点爆炸，对于一条存在时间为 $m$ 的边，如果我们朴素的在每个被其包含的区间都插入一遍的话，可以看出其被插入的次数仍然是 $\mathcal{O}(m)$ 的。那最终的时间复杂度肯定还是炸的。

说了这么久的并查集，现在终于轮到线段树出场了。首先不难看出，上述的分治过程构成了一个线段树形的结构，那么类似线段树优化建图，我们可以将每一条边存在的时间区间**拆成时间轴线段树上的 $\mathcal{O}(\log n)$ 个区间**，这样，每条边被插入的次数就是 $\log$ 级别的，那么总体时间复杂度就为 $\mathcal{O}(n \log^2 n)$，已经足够好了。

观察上边的过程，我们可以发现，最重要的思想是**对时间轴进行分治**。类似不删除莫队，当我们发现题目中给定的操作很难删除，但撤销其影响相对容易时，我们就可以考虑线段树分治。

